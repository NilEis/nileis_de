---
import Version from "../components/Version.astro";
import TitleAndMeta from "../components/TitleAndMeta.astro";
import LinkList from "../components/LinkList.astro";
import { routes } from "../data/routes.ts";
import MainContent from "../components/MainContent.astro";
import { Count } from "./api/count";
export const prerender = false;
console.log("Index page prerendering disabled");
await Count();
console.log("Count API called");
const visitors = await (await fetch(new URL("/api/count", Astro.url))).text();
console.log("Visitors count fetched:", visitors);
---

<TitleAndMeta />
<div class="sr-only" id="bg-description"></div>
<MainContent
  id="background"
  class={`bg-black bg-cover bg-no-repeat bg-center flex justify-center items-center h-screen w-screen`}
  aria-describedby="bg-description"
>
  <div
    class="fixed top-0 left-0 bg-gray-200 bg-opacity-25 rounded p-2"
    aria-hidden="true"
    id="title_div"
  >
  </div>
  <LinkList
    sites={routes}
    outerClass="h-screen"
    middleClass="bg-white bg-opacity-75 rounded p-4"
  >
    <div
      class="font-medium text-blue-600 dark:text-blue-500 hover:underline"
      id="rerender"
    >
      Reload background
    </div>
    <div class="text-gray-500 dark:text-gray-400">
      <span id="count">{visitors}</span> visitors
    </div>
    <Version slot="after-list" />
  </LinkList>
  <div
    class="fixed bottom-0 left-0 bg-gray-200 bg-opacity-25 rounded p-2"
    aria-hidden="true"
    id="copyright_div"
  >
  </div>
  <div
    class="fixed bottom-0 right-0 bg-gray-200 bg-opacity-25 rounded p-2"
    aria-hidden="true"
    id="date_div"
  >
  </div>
</MainContent>

<script>
  import { renderBackground } from "./main.ts";
  console.log("Rendering background image");
  const fetchedMaxImage = await fetch("/nasa/apod/pictures.json");
  const maxImage = await fetchedMaxImage.json();
  console.log("Fetched max image data:", fetchedMaxImage);
  await renderBackground(maxImage);
  console.log("Background image rendered");
  document.getElementById("rerender")!.onclick = async () => {
    await renderBackground(maxImage);
  };
  console.log("Rerender button set up");
</script>
